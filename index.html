<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MoePICs</title>
    <!-- 强制移动设备以app模式打开页面(即在移动设备下全屏，仅支持部分浏览器) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="full-screen" content="yes">
    <!--UC强制全屏-->
    <meta name="browsermode" content="application">
    <!--UC应用模式-->
    <meta name="x5-fullscreen" content="true">
    <!--QQ强制全屏-->
    <meta name="x5-page-mode" content="app">
    <!--QQ应用模式-->
    <meta name="description" content="MoePICs"/>
    <link rel="shortcut icon" href="favicon.jpg">
    <link rel="stylesheet" type="text/css" href="css/materialize.css">
	<link rel="stylesheet" type="text/css" href="css/icon.css">

	<link rel="stylesheet" type="text/css" href="css/normalize.css" />
	<link rel="stylesheet" type="text/css" href="css/demo.css" />
	<link href="./css/viewer.min.css" rel="stylesheet">
	<link rel="stylesheet" href="css/floating.css">
	<link rel="stylesheet" type="text/css" href="css/loading.css" />
	<link rel="stylesheet" type="text/css" href="css/style.css" />
	<link rel="stylesheet" href="css/pushbar.css">
</head>
	<div id="modal1" class="modal"></div>
	<div id='fitler' class='btn-floating btn-large waves-effect waves-light blue' onclick="modal_fitler();">
		<i class='material-icons'>filter_list</i>
	</div>
	<body class="loading">
			
		<main>
		<div id="contactUs">
	  <div id="countrySelection">
	    <div id="countrySelection-wrapper">
	      <ul id="countrySelection-items" style="">
	      	<li class="countrySelection-item" title="log" id="control-grid-log">
	          <a href="#">log</a>
	        </li>
	      	<li class="countrySelection-item" title="favorite" id="control-grid-favorite">
	          <a href="#">favorite</a>
	        </li>
	        <li class="countrySelection-item active" title="konachan" id="control-grid-konachan">
	          <a href="#">konachan</a>
	        </li>
	        <li class="countrySelection-item" title="yande" id="control-grid-yande">
	          <a href="#">yande</a>
	        </li>
	        <li class="countrySelection-item" title="danbooru" id="control-grid-danbooru">
	          <a href="#">danbooru</a>
	        </li>
	        <li class="countrySelection-item" title="behoimi" id="control-grid-behoimi">
	          <a href="#">behoimi</a>
	        </li>
	        <li class="countrySelection-item" title="safebooru" id="control-grid-safebooru" >
	          <a href="#">safebooru</a>
	        </li>
	        <li class="countrySelection-item" title="lolibooru" id="control-grid-lolibooru">
	          <a href="#">lolibooru</a>
	        </li>
	        <li class="countrySelection-item" title="gelbooru" id="control-grid-gelbooru">
	          <a href="#">gelbooru</a>
	        </li>
	        <li class="countrySelection-item" title="worldcosplay" id="control-grid-worldcosplay">
	          <a href="#">worldcosplay</a>
	        </li>
	        <li class="countrySelection-item" title="kawaiinyan" id="control-grid-kawaiinyan">
	          <a href="#">kawaiinyan</a>
	        </li>
	        <li class="countrySelection-item" title="bilibili" id="control-grid-bilibili">
	          <a href="#">bilibili</a>
	        </li>
	         <li class="countrySelection-item" title="sankakucomplex" id="control-grid-sankakucomplex">
	          <a href="#">sankakucomplex</a>
	        </li>
	         <li class="countrySelection-item" title="anime_picture" id="control-grid-anime_picture">
	          <a href="#">anime_picture</a>
	        </li>
	         <li class="countrySelection-item" title="zerochan" id="control-grid-zerochan">
	          <a href="#">zerochan</a>
	        </li>
	         <li class="countrySelection-item" title="shuushuu" id="control-grid-shuushuu">
	          <a href="#">shuushuu</a>
	        </li>
	         <li class="countrySelection-item" title="minitokyo" id="control-grid-minitokyo">
	          <a href="#">minitokyo</a>
	        </li>
	         <li class="countrySelection-item" title="e926" id="control-grid-e926">
	          <a href="#">e926</a>
	        </li>
	         <li class="countrySelection-item" title="e621" id="control-grid-e621">
	          <a href="#">e621</a>
	        </li>
	         <li class="countrySelection-item" title="hypnohub" id="control-grid-hypnohub">
	          <a href="#">hypnohub</a>
	        </li>
	         <li class="countrySelection-item" title="rule34" id="control-grid-rule34">
	          <a href="#">rule34</a>
	        </li>
	      </ul>
	    </div>
	  </div>
	</div>

	
  <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>


			<div class="content content--center" id='host_layout'>
				<div class="grid grid--type-log" title='log'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-favorite" title='favorite'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-yande" title='yande'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-konachan" title='konachan'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-safebooru" title='safebooru'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-danbooru" title='danbooru'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-behoimi" title='behoimi'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-gelbooru" title='gelbooru'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-worldcosplay" title='worldcosplay'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-kawaiinyan" title='kawaiinyan'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-bilibili" title='bilibili'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-lolibooru" title='lolibooru'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-sankakucomplex" title='sankakucomplex'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-anime_picture" title='anime_picture'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-shuushuu" title='shuushuu'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-minitokyo" title='minitokyo'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-e926" title='e926'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-e621" title='e621'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-hypnohub" title='hypnohub'>
					<div class="grid__sizer"></div>
				</div>
				<div class="grid grid--type-rule34" title='rule34'>
					<div class="grid__sizer"></div>
				</div>
			</div>
		</main>
	<div class="loader1">
    	<i></i><i></i>
  	</div>


	<link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.2.0/css/font-awesome.min.css" />
	<link rel="stylesheet" type="text/css" href="css/menu_cornermorph.css" />

	<script type='text/javascript' src='./js/jquery.min.js'></script>
	<script type='text/javascript' src='./js/var.js'></script>

	<script type="text/javascript" src='js/api.js'></script>
	<script src="./js/viewer.js"></script>
	<script type="text/javascript" src='js/test.js'></script>
	
	<script src="js/imagesloaded.pkgd.min.js"></script>
	<script src="js/masonry.pkgd.min.js"></script>
	<script src="js/anime.min.js"></script>
	<script src="js/blooming-menu.min.js"></script>
	<script src="js/floating.js"></script>
	<script src='js/jquery-ui.min.js'></script>
	<script src='js/index.js'></script>	
	<script src="js/background-blur.min.js"></script>    


	<link rel="stylesheet" href="css/x0popup.min.css">
	<script src="js/x0popup.min.js"></script>   

	<link rel="stylesheet" href="css/optiscroll.css">
	<script src="js/jquery.optiscroll.min.js"></script>  

	<script type="text/javascript" src='js/host.js'></script>
	<script src="js/main.js"></script>
	<script type="text/javascript" src='js/materialize.min.js'></script>

	<script type="text/javascript">

		var g_j_tag; // 编辑标签的json

		function confirm_removeFavorite(){
			x0p('Confirmation', 'Sure to remove from favorite ?', 'warning').then(
			    function(data) {
			        if(data.button == 'warning') {
			        	var fk = g_j_tag.host+'_'+g_j_tag.id;
						setFavorite(g_j_tag, false);
						$('#modal1').modal('close');
			            x0p('Congratulations', 
			                'Removed', 
			                'ok', false);
			        }
			    });
		}

		function addToFavoriteTag(tag){
			var i = g_v_favorite_tags.indexOf(tag);
			if(i === -1){
				g_v_favorite_tags.push(tag);
				s = '';
			}else{
				delete g_v_favorite_tags[i];
				s = '_border';
			}
			setLocalData('tags', JSON.stringify(g_v_favorite_tags));
			$('.chip span:contains('+tag+')').next().html('star'+s);
		}

		function modal_fitler(){
			var tags = [];
			for(var s_tag of g_v_search.tags.split('+')){
				if(s_tag != '') tags.push({tag: s_tag});
			}
			var html = '';

			var b = isHost();
			var tag_all = b ? g_v_favorite_tags : g_a_tags;
			for(var tag of tag_all){
				html = html + `<div class="chip"><span onclick="$('.chips-placeholder').chips('addChip', {'tag': '`+tag+`'})">`+tag+`</span><i class="material-icons" onclick="addToFavoriteTag('`+tag+`')">star`+(g_v_favorite_tags.indexOf(tag) === -1 ? '_border' : '')+`</i></div>`;
			}
			if(html != ''){
				html = ' <div id="dtags" class="chips">'+html+'</div>';
			}
			$('#modal1').html(`
				<div class="modal-content">
				<div id='tag_fitler'>
				<div class="chips chips-placeholder"></div>
				 <ul class="collection"></ul>
			       </div>
			    </div>
			    `+html+`
			    <div class="modal-footer">
			      <a href="javascript: resetChips();" class="waves-effect waves-green btn-flat">Reset</a>
			      <a href="javascript: fitler_apply();" class="modal-close waves-effect waves-green btn-flat">Apply</a>
			    </div>
				`).modal('open');
				$('.chips-placeholder').chips({
					data: tags,
				    placeholder: 'Enter a tag',
				    secondaryPlaceholder: '+Tag',
				  });
		}

		function isHost(){
			return g_v_search.host !== 'favorite' && g_v_search.host !== 'log';
		}

		function resetChips(){
			var instance = M.Chips.getInstance($('.chips-placeholder')[0]);
			instance.chipsData = [];
			 M.Chips.init($('.chips-placeholder')[0]);
			// insta
			// for(var i=instance.chipsData.length;i>0;i--){
			// 	instance.deleteChip(i);
			// }
		}

		function fitler_apply(){
			g_v_search.tags = getChipsTags().join('+');
			resetHost();
			getData(g_v_search.host, getPost());
		}

		function modal_tag(host, id, index){
			var html = '';
			var tags = [];
			g_j_tag = getPicJson(host, index);
			if(g_j_tag != undefined){
				var fk = g_j_tag.host+'_'+g_j_tag.id;
				var i = getFavorite(fk);
				if(i === undefined) setFavorite(g_j_tag, true)
				var d = g_v_favorite_list.post[fk];
				if(d.ctags != undefined){
					for(var s_tag of d.ctags){
						tags.push({tag: s_tag});
					}
				}

				if(g_j_tag.tags != undefined){
					for(var tag of g_j_tag.tags.split(' ')){
						html = html + `<div class="chip"><span onclick="$('.chips-placeholder').chips('addChip', {'tag': '`+tag+`'})">`+tag+`</span><i class="material-icons" onclick="addToFavoriteTag('`+tag+`')">star`+(g_v_favorite_tags.indexOf(tag) === -1 ? '_border' : '')+`</i></div>`;
					}
				}
				if(html != ''){
					html = ' <div id="dtags" class="chips">'+html+'</div>';
				}
			}
			// console.log(g_j_tag);
			// var tags = [{
			// 	      tag: 'Apple',
			// 	    }, {
			// 	      tag: 'Microsoft',
			// 	    }, {
			// 	      tag: 'Google',
			// 	    }];
			$('#modal1').html(`
				<div class="modal-content">
				<div id='tag_edit'>
				`+html+`
				<div class="chips chips-placeholder"></div>
				 <ul class="collection"></ul>
			       </div>
			    </div>
			    <div class="modal-footer">
			      <a href="javascript: confirm_removeFavorite();" class="waves-effect waves-green btn-flat">Remove</a>
			      <a href="#!" class="modal-close waves-effect waves-green btn-flat">Exit</a>
			    </div>
				`).modal('open');
			$('#tag_edit .collection li i').click(function(event) {
					x0p('Confirmation', 'Are you want to delete tag : '+this.parentElement.firstElementChild.innerText+'?', 'warning').then(
				    function(data) {
				        if(data.button == 'warning') {
				            x0p('Congratulations', 
				                'Your name is ' + data.text + '!', 
				                'ok', false);
				        }
				    });
				});
				$('.chips-placeholder').chips({
					data: tags,
				    placeholder: 'Enter a tag',
				    secondaryPlaceholder: '+Tag',
				    onChipAdd: function(){
				    	Event_ChipsTagsChange();
				    },
				    onChipDelete: function(){
				    	Event_ChipsTagsChange();
				    }
				  });
			$('.chips-placeholder input')[0].oninput = function(){
				var s = $(this).val().toLocaleLowerCase();
				var html = '';
				for (var i=0; i<g_a_tags.length;i++) {
					var tag = g_a_tags[i];
                    var i_s = tag.toLocaleLowerCase().indexOf(s);
                    if (i_s !== -1) {
                    	html = html + `<li class="collection-item">
				      <span>`+tag+`</span>
				      <i class='material-icons right'>close</i>
				      </li>`;
                    }
                }
                $('#tag_edit .collection').html(html);
			}
			$('.chips-placeholder input')[0].oninput();
		}

		function Event_ChipsTagsChange(){
			var fk = g_j_tag.host+'_'+g_j_tag.id;
			g_j_tag.ctags = getChipsTags();
			setFavorite(g_j_tag, true);
		}

		function getChipsTags(){
			var tags = [];
			for(var d of M.Chips.getInstance($('.chips-placeholder')[0]).chipsData){
				tags.push(d.tag.trim());
			}
			return tags;
		}

		$(function() {
			M.AutoInit();
			var scrolldom = $('body').optiscroll({
				checkFrequency: true,
				forceScrollbars: true
			});
			scrolldom.on('scrollreachbottom', function (ev) {
				if(!g_b_loading){
		    		nextPage();
		    	}
			});  

			setHost(g_a_log.lastHost,'post', true);
			var g_v_grid_down = {
				start: 0,
				task: -1,
				element: null,
				holding: false
			};

			window.history.pushState(null, null, "#");
		     window.addEventListener("popstate", function(event) {
		        window.history.pushState(null, null, "#");
		        event.preventDefault(true);
				event.stopPropagation();
				if(g_v_gallery_info.open){
					g_v_gallery_info.gallery.hide();
				}
		     })

			$('body')
			.on('click', '#tag_edit .collection li span', function(event) {
				$('.chips-placeholder input').val('');
				$('#tag_edit .collection').html('');
				$('.chips-placeholder').chips('addChip', {'tag': this.innerText});
			})
			.on('click', '#tag_edit #dtag i', function(event) {
				$('.chips-placeholder').chips('addChip', {'tag': this.innerText});
			})
			.on('click', 'a', function(event){
				var dom = $(event.target);
				var s_name = dom.attr('action_name');
				switch(s_name){
					case 'close':
						_window_close();
						break;
				}
			})
			.on('click', '.grid__img', function(event) {
				loadGallery($(this));
			})
			.on('touchstart', '.grid__img', function(event) {
				_window_close();

				var dom = $(this);
				g_v_grid_down.start = getNow();
				g_v_grid_down.task = window.setTimeout(function(){
					if(g_v_grid_down.start > 0){
						console.log('长按');
						g_v_grid_down.holding = true;
						var json = getPicJson(dom.parent().attr('data-host'), dom.parent().attr('data-id-index'));
						console.log(json);
						if(json != undefined){
							//_window_picInfo(json);
						}
					}
					g_v_grid_down.start = 0;
					g_v_grid_down.task = -1;
					event.preventDefault(true);
					event.stopPropagation();
				}, 1000);
			})
			.on('touchend', '.grid__img', function(event) {
				if(g_v_grid_down.task != -1){
					window.clearTimeout(g_v_grid_down.task);
				}
				g_v_grid_down.start = 0;
				if(g_v_grid_down.holding){
					console.log('长按弹起');
					event.preventDefault(true);
					event.stopPropagation();
				}
				g_v_grid_down.holding = false;
			});
		});

		function setLoading(b_loading){
			$('.loader1').toggle(b_loading);
			g_i_lastloading = 0;
		}

</script>
</body>
</html>